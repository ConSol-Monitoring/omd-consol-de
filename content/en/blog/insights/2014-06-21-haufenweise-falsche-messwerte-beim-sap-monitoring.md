---
author: Gerhard Laußer
date: '2014-06-21T21:31:08+00:00'
slug: haufenweise-falsche-messwerte-beim-sap-monitoring
tags:
- ccms
title: Haufenweise falsche Messwerte beim SAP-Monitoring (Update)
---

<p>Bei der Ablösung des alten SAP-Monitorings eines unserer Kunden bin ich über Ungereimtheiten beim Auslesen von CCMS-Metriken gestolpert. Nicht alle Werte, welche man per RZ20 in der SAP-GUI angezeigt bekommt, werden nagios-seitig korrekt wiedergegeben. Teilweise sind die Messwerte um den Faktor 1000 zu hoch und werden so auch in den entsprechenden RRD-Files abgespeichert bzw. sorgen für ungläubiges Kopfschütteln. Das ist beispielsweise dann der Fall wenn der SAP-Server eine Load von <b>7.06</b> hat, laut Monitoring aber <b>706</b>. Bisher ist das halt nicht aufgefallen, weil üblicherweise der von SAP gelieferte Status eins zu eins in Nagios verwendet wurde.</p>  <p><img style="width: 100%; margin: 0px" src="/assets/downloads/nagios/ccms-load-rz20.png" /></p>  <p><i>Update 23.6.14: im Git von check_mk wurde mein Patch mittlerweile eingespielt.      <br />Update 26.6.14: im Git von Netways auch.       <br />Update: Die beiden angemeckerten Plugins sind (Stand 26.6.14) gefixt und somit ist meiner Stänkerei jede Grundlage entzogen. Alles ist gut :-)</i></p>  <p>&#160;</p><!--more--><p>Ich habe mir dann mal in einer Testumgebung die gängigsten Plugins für's SAP-Monitoring installiert und verglichen, was die denn so messen.</p>  <table class="nagiosplugins" style="width: 643px; border-collapse: collapse; table-layout: fixed"><tbody></tbody><colgroup style="width: 210px; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; padding-right: 0px"></colgroup><colgroup style="width: 150px; padding-left: 15px"></colgroup><colgroup style="width: 280px; padding-left: 15px"></colgroup><tbody>     <tr>       <td style="vertical-align: middle; padding-top: 15px" colspan="3"><b>check_mk</b></td>     </tr>      <tr>       <td style="vertical-align: middle" rowspan="2"><a style="text-decoration: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; padding-right: 0px" href="/assets/downloads/nagios/ccms-load-check_mk.png"><img style="border-left-width: 0px; border-right-width: 0px; width: 100%; border-bottom-width: 0px; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px; border-top-width: 0px" src="/assets/downloads/nagios/ccms-load-check_mk.png" /></a></td>        <td style="vertical-align: middle">Korrekter Wert</td>        <td style="vertical-align: middle">Ja, weil mittlerweile korrigiert&#160; <br />(Anm.: statt ALRELEVVAL wird LASTPERVAL ausgelesen)</td>     </tr>      <tr>       <td style="vertical-align: middle">Performancedaten</td>        <td style="vertical-align: middle">Ja, ohne Schwellwerte</td>     </tr>      <tr>       <td style="vertical-align: middle; padding-top: 15px" colspan="3"><b>check_sap von Netways</b></td>     </tr>      <tr>       <td style="border-left-width: 0px; border-right-width: 0px; vertical-align: middle; border-bottom-width: 0px; border-top-width: 0px" rowspan="2"><a style="text-decoration: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; padding-right: 0px" href="/assets/downloads/nagios/ccms-load-check_sap-netways.png"><img style="border-left-width: 0px; border-right-width: 0px; width: 100%; border-bottom-width: 0px; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px; border-top-width: 0px" src="/assets/downloads/nagios/ccms-load-check_sap-netways.png" /></a></td>        <td style="vertical-align: middle">Korrekter Wert</td>        <td style="vertical-align: middle">Ja, weil mittlerweile korrigiert</td>     </tr>      <tr>       <td style="vertical-align: middle">Performancedaten</td>        <td style="vertical-align: middle">Ja, mit Schwellwerten          <br />(optional sogar mit Ranges)</td>     </tr>      <tr>       <td style="vertical-align: middle; padding-top: 15px" colspan="3"><b>check_sap von Sourceforge</b></td>     </tr>      <tr>       <td style="border-left-width: 0px; border-right-width: 0px; vertical-align: middle; border-bottom-width: 0px; border-top-width: 0px" rowspan="2"><a style="text-decoration: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; padding-right: 0px" href="/assets/downloads/nagios/ccms-load-check_sap-sourceforge.png"><img style="border-left-width: 0px; border-right-width: 0px; width: 100%; border-bottom-width: 0px; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px; border-top-width: 0px" src="/assets/downloads/nagios/ccms-load-check_sap-sourceforge.png" /></a></td>        <td style="vertical-align: middle">Korrekter Wert</td>        <td style="vertical-align: middle">Ja</td>     </tr>      <tr>       <td style="vertical-align: middle">Performancedaten</td>        <td style="vertical-align: middle">Nein          <br />(In der Graphik ja, allerdings wurde das Plugin nachträglich gepatcht)</td>     </tr>      <tr>       <td style="vertical-align: middle; padding-top: 15px" colspan="3"><b>check_sap_health von ConSol</b></td>     </tr>      <tr>       <td style="border-left-width: 0px; border-right-width: 0px; vertical-align: middle; border-bottom-width: 0px; border-top-width: 0px" rowspan="2"><a style="text-decoration: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; padding-right: 0px" href="/assets/downloads/nagios/ccms-load-check_sap_health-consol.png"><img style="border-left-width: 0px; border-right-width: 0px; width: 100%; border-bottom-width: 0px; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px; border-top-width: 0px" src="/assets/downloads/nagios/ccms-load-check_sap_health-consol.png" /></a></td>        <td style="vertical-align: middle">Korrekter Wert</td>        <td style="vertical-align: middle">Ja</td>     </tr>      <tr>       <td style="vertical-align: middle">Performancedaten</td>        <td style="vertical-align: middle">Ja, mit Schwellwerten          <br />(Die vom CCMS vorgegebenen Schwellwerte können auch mittels --warning/--critical überschrieben werden, so wie hier mit --warningx CPU_5minLoadAverage=9.99)</td>     </tr>   </tbody></table>  <p>Der Grund für die falschen Werte ist die Nichtberücksichtigung eines Umrechnungsfaktors, der von SAP mitgeliefert wird. Wenn man mit BAPI_SYSTEM_MTE_GETPERFCURVAL die Detailangaben eines Performance-MTEs holt, dann steckt der Messwert im Feld ALRELEVVAL. Da dieses vom Typ Integer ist und somit einen Wert wie 7.06 nicht richtig abbilden kann, kommt noch ein weiteres Feld DECIMALS mit.</p>
~~~
ALRELEVVAL   706
ALRELVALDT   20140614
ALRELVALTI   080801
ALTREENUM    1
ATTRGROUP    5minLoadAverage
...
DECIMALS     2
~~~
<p>Dieses wird verwendet, um ALRELEVVAL durch eine bestimmte Größenordnung zu dividieren. Dabei gilt die Formel:</p>

<p><b>in RZ20 angezeigter Wert = ALRELEVVAL / 10 ** DECIMALS</b></p>

<p>Und damit es nicht wieder heisst, der Laußer kann nur blöd daherreden und kritisieren, habe ich mich hingesetzt und Patches erstellt. Zum Download geht's hier lang:</p>

<p>Einmal für Netways, bitte schön
  <br /><a href="/assets/2014-06-21-haufenweise-falsche-messwerte-beim-sap-monitoring/0001-check_sap-recalculate-alrelevval-if-decimals-is-set.patch.txt" target="_self">check_sap.patch</a></p>

<p>und einmal für Kettner, bitte schön
  <br /><a href="/assets/2014-06-21-haufenweise-falsche-messwerte-beim-sap-monitoring/0001-mk_sap-recalculate-alrelevval-if-decimals-is-set.patch.txt" target="_self">check_mk.patch</a></p>

<p>Bleibt noch herauszufinden, welche der CCMS-Metriken betroffen sind und welche RRD-Files repariert werden müssen. Sowas lässt sich einfach per Script automatisiert erledigen. Wenden sie sich bitte an ihren jeweiligen Dienstleister :-)</p>